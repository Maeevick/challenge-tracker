---
date: 2024-10-04
impressions: 2142
reactions: 37
comments: 11
shares: 0
followers: 20
tags: NodeJS PerformanceTroubleshooting OctoberChallenge
---

# üö® Alerte fuite m√©moire ! Comment on a sauv√© notre lancement produit √† la derni√®re minute...

Il y a bien longtemps dans une galaxie fort fort lointaine (pas si longtemps et pas si lointaine), on allait passer de notre version beta r√©serv√©e aux early-adopters √† notre version publique avec un lancement en fanfare.

Le cash allait pleuvoir et le Product/Market Fit explos√© üí∞üí∞üí∞

üò± Mais, imagine : J-3 avant la release et l'annonce marketing, notre backend NodeJS (h√©berg√© sur un VPS chez un Cloud Provider) commence √† montrer des signes de faiblesse.

R√©flexe facile : on scale up l'instance.

Sans succ√®s : le monitoring montre que la consommation m√©moire grimpe en fl√®che, sans raison puisqu'il n'y a pas vraiment plus de charge.

Le stress monte.

On mitraille l'API √† coups de Vegeta (load testing), pas de grandes diff√©rences sur la m√©moire !

üò± Un truc cloche. J-2.

Voici les trois outils natifs de l'√©cosyst√®me NodeJS qui nous ont sauv√©s :

- 1Ô∏è‚É£ "node --inspect" pour se connecter au "Remote Debugger de Node" via "chrome://inspect".
- 2Ô∏è‚É£ "node --trace-gc" pour logger l'activit√© du Garbage Collector.
- 3Ô∏è‚É£ ajouter un petit "process.memoryUsage()" pour logger l'utilisation m√©moire du process node chaque seconde.

Des libs et outils √† installer, il y en a beaucoup mais plus ou moins maintenus et pertinents (node-memwatch, clinic.js, ...). Par choix (une erreur apr√®s coup) on n'avait pas de monitoring sur le process node (Sentry, New Relic, Datadog ou autre).

Bref.

On a pu voir que le GC ne lib√©rait pas la m√©moire utilis√©e !!!

Et tout √ßa √† cause d'une connexion websocket qui n'√©tait jamais ferm√©e. Ce fameux `ws.on("close", ...)` si facile √† oublier.

Le fix est arriv√© √† J-1 et le lancement a pu se faire comme pr√©vu mais au prix de cheveux blancs pour tout le monde.

Une bonne le√ßon apprise : monitore ton application en plus de ton infrastructure et ma√Ætrise les outils de debugging de ta stack, √ßa peut te sauver la vie quand le temps presse.

Tu as d√©j√† affront√© des fuites m√©moire en prod ? Partage tes exp√©riences !

---

üé• J'ai essay√© de reproduire une simulation dans la vid√©o :

- ‚úÖ √Ä gauche : codebase sans fuite m√©moire, le GC passe, la m√©moire reste stable.
- ‚ùå √Ä droite : codebase avec fuite m√©moire, le GC passe, la m√©moire augmente

Il a fallu 51 secondes avant que le serveur explose en utilisation m√©moire avec 7 clients (bon je cr√©e des tableaux de 1.000.000 d'items chaque seconde pour que √ßa ne dure pas des heures mais tu vois l'id√©e).

---

Tu me d√©couvres ou me red√©couvres avec ce post ?

üõ†Ô∏è Pendant tout le mois d'octobre, je publie un post par jour autour de NodeJS, de TypeScript et d'Architecture Logicielle.

#NodeJS #PerformanceTroubleshooting #OctoberChallenge
